{% extends 'base.html' %}

{% block title %}Inventory{% endblock %}

{% block styles %}
<style nonce="{{ csp_nonce() }}">
.inventory-table th:nth-child(n+4):nth-child(-n+7),
.inventory-table td:nth-child(n+4):nth-child(-n+7) {
    text-align: right;
    min-width: 90px;
}
.inventory-table th:nth-child(8),
.inventory-table td:nth-child(8) {
    text-align: center;
    min-width: 60px;
}
.inventory-table th:nth-child(9),
.inventory-table td:nth-child(9) {
    text-align: center;
}
.inventory-totals-row {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-top: 2px solid #0d6efd;
    font-size: 1.05rem;
}
.inventory-totals-row th {
    font-weight: 700;
    color: #0d6efd;
    padding: 0.875rem 0.75rem;
}
.inventory-totals-row td {
    font-weight: 600;
    padding: 0.875rem 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header-modern">
        <div class="page-title-group">
            <h1>
                <i class="bi bi-boxes"></i>
                Inventory Summary
            </h1>
            <p class="subtitle">View and manage inventory across all warehouses</p>
        </div>
        <div class="d-flex gap-2">
            {% if has_feature('inventory_intake') %}
            <a href="{{ url_for('intake.list_intakes') }}" class="btn btn-modern btn-primary">
                <i class="bi bi-arrow-down-circle me-2"></i>
                Record Intake
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <form method="GET" class="d-flex align-items-center gap-3 flex-wrap">
            <label for="warehouse_id" class="form-label mb-0 font-semibold text-nowrap">
                <i class="bi bi-building me-1"></i>
                Warehouse:
            </label>
            <select class="form-control filter-select" name="warehouse_id" id="warehouse_id" data-auto-submit="true">
                <option value="">All Warehouses</option>
                {% for warehouse in warehouses %}
                <option value="{{ warehouse.warehouse_id }}" {% if selected_warehouse_id == warehouse.warehouse_id %}selected{% endif %}>
                    {{ warehouse.warehouse_name }}
                </option>
                {% endfor %}
            </select>
            
            <label for="item_id" class="form-label mb-0 font-semibold text-nowrap ms-3">
                <i class="bi bi-box-seam me-1"></i>
                Item:
            </label>
            <select class="form-control filter-select" name="item_id" id="item_id" data-auto-submit="true">
                <option value="">All Items</option>
                {% for item in items %}
                <option value="{{ item.item_id }}" {% if selected_item_id == item.item_id %}selected{% endif %}>
                    {{ item.item_name }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Inventory Table -->
    {% if inventory_items %}
    {% set totals = namespace(usable=0, reserved=0, defective=0, expired=0) %}
    {% for inv, _, _, _ in inventory_items %}
        {% set totals.usable = totals.usable + inv.usable_qty %}
        {% set totals.reserved = totals.reserved + inv.reserved_qty %}
        {% set totals.defective = totals.defective + inv.defective_qty %}
        {% set totals.expired = totals.expired + inv.expired_qty %}
    {% endfor %}

    <div class="table-responsive-mobile">
        <table class="modern-table inventory-table">
            <caption class="visually-hidden">Inventory quantities by warehouse and item</caption>
            <thead>
                <tr>
                    <th scope="col">Warehouse</th>
                    <th scope="col">Item</th>
                    <th scope="col">SKU</th>
                    <th scope="col">Usable</th>
                    <th scope="col">Reserved</th>
                    <th scope="col">Defective</th>
                    <th scope="col">Expired</th>
                    <th scope="col">UOM</th>
                    <th scope="col">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for inv, item_name, sku_code, warehouse_name in inventory_items %}
                <tr>
                    <td>
                        <strong>{{ warehouse_name }}</strong>
                    </td>
                    <td>{{ item_name }}</td>
                    <td>
                        <code class="code-pill">{{ sku_code }}</code>
                    </td>
                    <td>
                        <strong class="text-success">{{ inv.usable_qty }}</strong>
                    </td>
                    <td>
                        <span class="text-warning">{{ inv.reserved_qty }}</span>
                    </td>
                    <td>
                        <span class="text-danger">{{ inv.defective_qty }}</span>
                    </td>
                    <td>
                        <span class="text-muted">{{ inv.expired_qty }}</span>
                    </td>
                    <td>{{ inv.uom_code }}</td>
                    <td>
                        <span class="status-badge status-badge-{{ inv.status_code|status_badge('inventory') }}">
                            {{ inv.status_code|status_label('inventory') }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="inventory-totals-row">
                    <th scope="row" colspan="3">
                        <i class="bi bi-calculator me-2"></i>Grand Total
                    </th>
                    <td><strong class="text-success">{{ totals.usable }}</strong></td>
                    <td><strong class="text-warning">{{ totals.reserved }}</strong></td>
                    <td><strong class="text-danger">{{ totals.defective }}</strong></td>
                    <td><strong class="text-muted">{{ totals.expired }}</strong></td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-boxes"></i>
        <h5>No Inventory Records</h5>
        <p>No inventory records found for the selected warehouse.</p>
        {% if has_feature('inventory_intake') %}
        <a href="{{ url_for('intake.list_intakes') }}" class="btn btn-modern btn-primary">
            <i class="bi bi-arrow-down-circle me-2"></i>
            Record Intake
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
// Auto-submit filter forms when dropdown changes
document.addEventListener('DOMContentLoaded', function() {
    const autoSubmitSelects = document.querySelectorAll('select[data-auto-submit="true"]');
    autoSubmitSelects.forEach(function(select) {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
});
</script>
{% endblock %}
