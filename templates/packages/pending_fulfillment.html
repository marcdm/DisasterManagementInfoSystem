{% extends 'base.html' %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wcag-accessible.css') }}">
{% endblock %}

{% block title %}Relief Packages - Pending Fulfillment{% endblock %}

{% block content %}
<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<div class="container-fluid" >
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb">
        <ol class="breadcrumb mb-3">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Pending Fulfillment</li>
        </ol>
    </nav>

    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-goj-green mb-1 h2">
                        <i class="bi bi-box-seam" aria-hidden="true"></i> 
                        <span>Eligible Requests - Pending Fulfillment</span>
                    </h1>
                    <p class="text-muted mb-0">Relief requests approved by ODPEM and awaiting package preparation</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages with ARIA live region -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div aria-live="polite" aria-atomic="true">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close alert"></button>
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if requests %}
    <section class="drims-card" aria-labelledby="fulfillment-requests-heading">
        <div class="visually-hidden">
            <h2 id="fulfillment-requests-heading">List of approved requests pending fulfillment</h2>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table drims-table table-hover mb-0" aria-label="Approved relief requests awaiting package preparation">
                    <caption class="visually-hidden">
                        Table showing approved relief requests that are awaiting package fulfillment, including tracking numbers, agencies, disaster events, request dates, number of items, status, urgency levels, and available actions. Total: {{ requests|length }} request{{ 's' if requests|length != 1 else '' }}
                    </caption>
                    <thead>
                        <tr>
                            <th scope="col">Tracking #</th>
                            <th scope="col">Agency</th>
                            <th scope="col">Event</th>
                            <th scope="col">Request Date</th>
                            <th scope="col">Items</th>
                            <th scope="col">Status</th>
                            <th scope="col">Urgency</th>
                            <th scope="col" class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in requests %}
                        <tr>
                            <td data-label="Tracking #"><strong>{{ req.tracking_no if req.tracking_no else req.reliefrqst_id }}</strong></td>
                            <td data-label="Agency">
                                {% if req.agency %}
                                    {{ req.agency.agency_name }}
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td data-label="Event">
                                {% if req.eligible_event %}
                                    {{ req.eligible_event.event_name }}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </td>
                            <td data-label="Request Date">
                                <time datetime="{{ req.request_date.isoformat() if req.request_date else '' }}">
                                    {{ req.request_date.strftime('%Y-%m-%d') if req.request_date else '-' }}
                                </time>
                            </td>
                            <td data-label="Items">
                                <span class="badge bg-secondary" aria-label="{{ req.items|length }} items requested">
                                    {{ req.items|length }} item{{ 's' if req.items|length != 1 else '' }}
                                </span>
                            </td>
                            <td data-label="Status">
                                {% if req.status_code == 3 %}
                                    <span class="badge badge-success-accessible" aria-label="Status: Approved and Awaiting Fulfillment">Approved - Awaiting Fulfillment</span>
                                {% elif req.status_code == 5 %}
                                    <span class="badge badge-warning-accessible" aria-label="Status: Partially Fulfilled">Partially Fulfilled</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ req.status.status_desc if req.status else 'Unknown' }}</span>
                                {% endif %}
                            </td>
                            <td data-label="Urgency">
                                {% if req.urgency_ind == 'C' %}
                                    <span class="badge badge-danger-accessible" aria-label="Urgency level: Critical">Critical</span>
                                {% elif req.urgency_ind == 'H' %}
                                    <span class="badge badge-danger-accessible" aria-label="Urgency level: High">High</span>
                                {% elif req.urgency_ind == 'M' %}
                                    <span class="badge badge-warning-accessible" aria-label="Urgency level: Medium">Medium</span>
                                {% elif req.urgency_ind == 'L' %}
                                    <span class="badge badge-info-accessible" aria-label="Urgency level: Low">Low</span>
                                {% else %}
                                    <span class="badge bg-light text-dark" aria-label="Urgency level: Unknown">Unknown</span>
                                {% endif %}
                            </td>
                            <td data-label="Actions" class="text-end">
                                <div class="btn-group" role="group" aria-label="Actions for request {{ req.tracking_no if req.tracking_no else req.reliefrqst_id }}">
                                    <a href="{{ url_for('packaging.prepare_package', reliefrqst_id=req.reliefrqst_id) }}" 
                                       class="btn btn-sm btn-success-accessible"
                                       aria-label="Prepare package for request {{ req.tracking_no if req.tracking_no else req.reliefrqst_id }}">
                                        <i class="bi bi-box-seam" aria-hidden="true"></i> Prepare Package
                                    </a>
                                    <a href="{{ url_for('requests.view_request', request_id=req.reliefrqst_id) }}" 
                                       class="btn btn-sm btn-primary-accessible"
                                       aria-label="View details of request {{ req.tracking_no if req.tracking_no else req.reliefrqst_id }}">
                                        <i class="bi bi-eye" aria-hidden="true"></i> View
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    
    <!-- Summary information for screen readers and visibility -->
    <div class="mt-3" aria-live="polite">
        <p class="text-muted">
            <strong>{{ requests|length }}</strong> approved request{{ 's' if requests|length != 1 else '' }} awaiting fulfillment
        </p>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle" aria-hidden="true"></i> 
        <span>No approved relief requests are currently awaiting package preparation.</span>
    </div>
    {% endif %}
</div>


{% endblock %}
