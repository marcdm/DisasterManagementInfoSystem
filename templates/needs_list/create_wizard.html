{% extends "base.html" %}
{% set active_page = 'needs_list' %}

{% block title %}Create Needs List - DRIMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="bi bi-plus-circle"></i> Create Needs List</h2>
        <p class="text-muted mb-0">Multi-step request submission</p>
    </div>
    <a href="{{ url_for('needs_list.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="progress mb-4" style="height: 8px;">
            <div class="progress-bar bg-success" id="wizardProgress" role="progressbar" style="width: 25%"></div>
        </div>
        
        <ul class="nav nav-pills nav-fill mb-4" id="wizardSteps">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-step="1">
                    <i class="bi bi-1-circle-fill"></i> Basic Info
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-step="2">
                    <i class="bi bi-2-circle"></i> Add Items
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-step="3">
                    <i class="bi bi-3-circle"></i> Review
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-step="4">
                    <i class="bi bi-4-circle"></i> Submit
                </a>
            </li>
        </ul>
    </div>
</div>

<form method="POST" id="needsListWizardForm">
    <div id="step1" class="wizard-step">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header card-header-goj">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Request Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="agency_id" class="form-label">Agency *</label>
                            <select name="agency_id" id="agency_id" class="form-select" required>
                                <option value="">Select Agency</option>
                                {% for agency in agencies %}
                                <option value="{{ agency.agency_id }}">{{ agency.agency_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="event_id" class="form-label">Event *</label>
                            <select name="event_id" id="event_id" class="form-select" required>
                                <option value="">Select Event</option>
                                {% for event in events %}
                                <option value="{{ event.event_id }}">{{ event.event_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="priority" class="form-label">Priority *</label>
                                <select name="priority" id="priority" class="form-select" required>
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="urgency" class="form-label">Urgency</label>
                                <select name="urgency" id="urgency" class="form-select">
                                    <option value="Routine" selected>Routine</option>
                                    <option value="Urgent">Urgent</option>
                                    <option value="Emergency">Emergency</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header card-header-goj">
                        <h5 class="mb-0"><i class="bi bi-person-circle"></i> Contact Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="requested_by_name" class="form-label">Requested By</label>
                            <input type="text" name="requested_by_name" id="requested_by_name" class="form-control" placeholder="Full name">
                        </div>

                        <div class="mb-3">
                            <label for="requested_by_contact" class="form-label">Contact Number</label>
                            <input type="text" name="requested_by_contact" id="requested_by_contact" class="form-control" placeholder="Phone number">
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea name="notes" id="notes" class="form-control" rows="3" placeholder="Additional notes (optional)"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="justification" class="form-label">Justification</label>
                            <textarea name="justification" id="justification" class="form-control" rows="3" placeholder="Reason for request (optional)"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="step2" class="wizard-step" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-header card-header-goj d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Select Items</h5>
                <div>
                    <input type="text" id="itemSearch" class="form-control form-control-sm" placeholder="Search items..." style="width: 250px;">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th class="py-2 px-3" style="width: 40%;">Item</th>
                                <th class="py-2 px-3 text-end" style="width: 20%;">Quantity *</th>
                                <th class="py-2 px-3" style="width: 40%;">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            {% for item in items %}
                            <tr class="item-row" data-item-name="{{ item.item_name|lower }}" data-category="{{ item.item_catg_desc|lower if item.item_catg_desc else '' }}">
                                <td class="py-2 px-3">
                                    <strong>{{ item.item_name }}</strong>
                                    {% if item.item_catg_desc %}
                                        <br><small class="text-muted">{{ item.item_catg_desc }}</small>
                                    {% endif %}
                                </td>
                                <td class="py-2 px-3">
                                    <input type="number" 
                                           name="item_{{ item.item_id }}_qty" 
                                           id="item_{{ item.item_id }}_qty"
                                           class="form-control form-control-sm item-qty-input" 
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00"
                                           data-item-id="{{ item.item_id }}"
                                           data-item-name="{{ item.item_name }}">
                                </td>
                                <td class="py-2 px-3">
                                    <input type="text" 
                                           name="item_{{ item.item_id }}_notes" 
                                           class="form-control form-control-sm" 
                                           placeholder="Optional notes">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted"><i class="bi bi-info-circle"></i> Enter quantity for items you need. Items with quantity = 0 will be ignored.</small>
            </div>
        </div>
    </div>

    <div id="step3" class="wizard-step" style="display: none;">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Review Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="text-muted small">Agency</label>
                            <div id="review_agency" class="fw-bold">-</div>
                        </div>
                        <div class="mb-2">
                            <label class="text-muted small">Event</label>
                            <div id="review_event" class="fw-bold">-</div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-2">
                                <label class="text-muted small">Priority</label>
                                <div id="review_priority">-</div>
                            </div>
                            <div class="col-6 mb-2">
                                <label class="text-muted small">Urgency</label>
                                <div id="review_urgency">-</div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="text-muted small">Requested By</label>
                            <div id="review_requested_by">-</div>
                        </div>
                        <div class="mb-2">
                            <label class="text-muted small">Contact</label>
                            <div id="review_contact">-</div>
                        </div>
                        <div class="mb-2" id="review_notes_container" style="display: none;">
                            <label class="text-muted small">Notes</label>
                            <div id="review_notes" class="p-2 bg-light rounded">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Selected Items</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="py-2 px-3">Item</th>
                                        <th class="py-2 px-3 text-end">Quantity</th>
                                    </tr>
                                </thead>
                                <tbody id="review_items">
                                    <tr>
                                        <td colspan="2" class="text-center text-muted py-3">No items selected</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <strong>Total Items:</strong>
                            <strong id="review_item_count">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="step4" class="wizard-step" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-check-circle text-success" style="font-size: 5rem;"></i>
                <h3 class="mt-4 mb-3">Ready to Submit</h3>
                <p class="text-muted mb-4">You have configured <strong id="final_item_count">0</strong> items for this needs list.</p>
                <input type="hidden" name="submission_action" id="submission_action" value="draft">
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-outline-secondary btn-lg" id="saveDraftBtn">
                        <i class="bi bi-save"></i> Save as Draft
                    </button>
                    <button type="button" class="btn btn-success btn-lg" id="submitBtn">
                        <i class="bi bi-send"></i> Create & Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
            <i class="bi bi-arrow-left"></i> Previous
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn">
            Next <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</form>

<script>
let currentStep = 1;
const totalSteps = 4;

function updateWizard() {
    document.querySelectorAll('.wizard-step').forEach((step, index) => {
        step.style.display = (index + 1 === currentStep) ? 'block' : 'none';
    });
    
    document.querySelectorAll('#wizardSteps .nav-link').forEach((link, index) => {
        const stepNum = index + 1;
        if (stepNum < currentStep) {
            link.classList.remove('active');
            link.classList.add('text-success');
            link.innerHTML = link.innerHTML.replace(/\d-circle(-fill)?/, stepNum + '-circle-fill');
        } else if (stepNum === currentStep) {
            link.classList.add('active');
            link.classList.remove('text-success');
        } else {
            link.classList.remove('active', 'text-success');
            link.innerHTML = link.innerHTML.replace(/\d-circle(-fill)?/, stepNum + '-circle');
        }
    });
    
    document.getElementById('wizardProgress').style.width = (currentStep / totalSteps * 100) + '%';
    
    document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').style.display = currentStep === totalSteps ? 'none' : 'block';
}

function validateStep(step) {
    if (step === 1) {
        const agency = document.getElementById('agency_id').value;
        const event = document.getElementById('event_id').value;
        if (!agency || !event) {
            alert('Please select both Agency and Event');
            return false;
        }
    } else if (step === 2) {
        const items = getSelectedItems();
        if (items.length === 0) {
            alert('Please add at least one item with a quantity greater than 0');
            return false;
        }
    }
    return true;
}

function getSelectedItems() {
    const items = [];
    document.querySelectorAll('.item-qty-input').forEach(input => {
        const qty = parseFloat(input.value) || 0;
        if (qty > 0) {
            items.push({
                id: input.dataset.itemId,
                name: input.dataset.itemName,
                qty: qty
            });
        }
    });
    return items;
}

function populateReview() {
    document.getElementById('review_agency').textContent = 
        document.getElementById('agency_id').selectedOptions[0]?.text || '-';
    document.getElementById('review_event').textContent = 
        document.getElementById('event_id').selectedOptions[0]?.text || '-';
    document.getElementById('review_priority').innerHTML = 
        '<span class="badge bg-' + getPriorityClass(document.getElementById('priority').value) + '">' + 
        document.getElementById('priority').value + '</span>';
    document.getElementById('review_urgency').textContent = 
        document.getElementById('urgency').value || '-';
    document.getElementById('review_requested_by').textContent = 
        document.getElementById('requested_by_name').value || '-';
    document.getElementById('review_contact').textContent = 
        document.getElementById('requested_by_contact').value || '-';
    
    const notes = document.getElementById('notes').value;
    const notesContainer = document.getElementById('review_notes_container');
    if (notes && notesContainer) {
        document.getElementById('review_notes').textContent = notes;
        notesContainer.style.display = 'block';
    } else if (notesContainer) {
        notesContainer.style.display = 'none';
    }
    
    const items = getSelectedItems();
    const reviewItemsBody = document.getElementById('review_items');
    if (items.length === 0) {
        reviewItemsBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">No items selected</td></tr>';
    } else {
        reviewItemsBody.innerHTML = items.map(item => `
            <tr>
                <td class="py-2 px-3">${item.name}</td>
                <td class="py-2 px-3 text-end">${item.qty.toFixed(2)}</td>
            </tr>
        `).join('');
    }
    document.getElementById('review_item_count').textContent = items.length;
    document.getElementById('final_item_count').textContent = items.length;
}

function getPriorityClass(priority) {
    const map = {'Critical': 'danger', 'High': 'danger', 'Medium': 'warning', 'Low': 'info'};
    return map[priority] || 'secondary';
}

document.getElementById('nextBtn').addEventListener('click', () => {
    if (validateStep(currentStep)) {
        if (currentStep === 2) {
            populateReview();
        }
        currentStep++;
        updateWizard();
    }
});

document.getElementById('prevBtn').addEventListener('click', () => {
    currentStep--;
    updateWizard();
});

document.getElementById('itemSearch').addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.item-row').forEach(row => {
        const itemName = (row.dataset.itemName || '').toLowerCase();
        const category = (row.dataset.category || '').toLowerCase();
        row.style.display = (itemName.includes(search) || category.includes(search)) ? '' : 'none';
    });
});

document.getElementById('saveDraftBtn').addEventListener('click', () => {
    if (confirm('Save this needs list as a draft?')) {
        document.getElementById('submission_action').value = 'draft';
        document.getElementById('needsListWizardForm').submit();
    }
});

document.getElementById('submitBtn').addEventListener('click', () => {
    if (confirm('Submit this needs list for approval?')) {
        document.getElementById('submission_action').value = 'submit';
        document.getElementById('needsListWizardForm').submit();
    }
});

updateWizard();
</script>

<style>
.wizard-step {
    min-height: 400px;
}
.nav-pills .nav-link {
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}
.nav-pills .nav-link.active {
    background-color: var(--goj-green);
}
.nav-pills .nav-link.text-success {
    color: #198754 !important;
}
</style>
{% endblock %}
