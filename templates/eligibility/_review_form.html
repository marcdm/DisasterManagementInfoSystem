{# Eligibility Review Form - Reusable Include #}
{# Expected context: request, can_edit, decision_made, STATUS_INELIGIBLE #}

{% if can_edit and not decision_made %}
<!-- Eligibility Decision Form -->
<div class="card drims-card mb-4">
    <div class="card-header bg-warning">
        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Eligibility Decision Required</h5>
    </div>
    <div class="card-body">
        <p class="mb-4">Please review the request details above and determine if this relief request meets eligibility criteria.</p>
        
        <form method="POST" action="{{ url_for('eligibility.submit_decision', request_id=request.reliefrqst_id) }}" id="eligibilityForm">
            <div class="mb-4">
                <label class="form-label fw-bold">Is this request eligible for relief?</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="decision" id="decisionYes" value="Y" checked>
                    <label class="form-check-label" for="decisionYes">
                        <strong>Yes - Eligible</strong>
                        <small class="text-muted d-block">This request meets eligibility criteria and can proceed to fulfillment</small>
                    </label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="decision" id="decisionNo" value="N">
                    <label class="form-check-label" for="decisionNo">
                        <strong>No - Ineligible</strong>
                        <small class="text-muted d-block">This request does not meet eligibility criteria</small>
                    </label>
                </div>
            </div>

            <div class="mb-4" id="reasonContainer" style="display: none;">
                <label for="reason" class="form-label fw-bold">
                    Reason for Ineligibility <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" id="reason" name="reason" rows="4" 
                          placeholder="Please provide a detailed reason why this request is ineligible..."></textarea>
                <small class="text-muted">This reason will be communicated to the requesting agency</small>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-warning" id="submitBtn">
                    <i class="bi bi-check-circle"></i> Confirm Decision
                </button>
                <a href="{{ url_for('requests.list_requests') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('eligibilityForm');
    if (!form) return;
    
    const decisionYes = document.getElementById('decisionYes');
    const decisionNo = document.getElementById('decisionNo');
    const reasonContainer = document.getElementById('reasonContainer');
    const reasonField = document.getElementById('reason');
    
    // Show/hide reason field based on decision
    function updateReasonVisibility() {
        if (decisionNo.checked) {
            reasonContainer.style.display = 'block';
            reasonField.required = true;
        } else {
            reasonContainer.style.display = 'none';
            reasonField.required = false;
            reasonField.value = '';
        }
    }
    
    decisionYes.addEventListener('change', updateReasonVisibility);
    decisionNo.addEventListener('change', updateReasonVisibility);
    
    // Form validation
    form.addEventListener('submit', function(e) {
        if (decisionNo.checked && !reasonField.value.trim()) {
            e.preventDefault();
            alert('Please provide a reason for marking this request as ineligible.');
            reasonField.focus();
            return false;
        }
        
        // Confirm decision
        const decision = decisionNo.checked ? 'INELIGIBLE' : 'ELIGIBLE';
        const confirmMsg = `Are you sure you want to mark this request as ${decision}?`;
        if (!confirm(confirmMsg)) {
            e.preventDefault();
            return false;
        }
    });
});
</script>

{% elif decision_made %}
<!-- Show decision details (read-only) -->
<div class="card drims-card mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="bi bi-check-circle"></i> Eligibility Decision</h5>
    </div>
    <div class="card-body">
        <table class="table table-sm table-borderless mb-0">
            <tr>
                <th width="30%">Decision:</th>
                <td>
                    {% if request.status_code == STATUS_INELIGIBLE %}
                        <span class="badge bg-danger">Ineligible</span>
                    {% else %}
                        <span class="badge bg-success">Eligible</span>
                    {% endif %}
                </td>
            </tr>
            {% if request.status_reason_desc %}
            <tr>
                <th>Reason:</th>
                <td>{{ request.status_reason_desc }}</td>
            </tr>
            {% endif %}
            {% if request.review_by_id %}
            <tr>
                <th>Reviewed By:</th>
                <td>{{ request.review_by_id }}</td>
            </tr>
            {% endif %}
            {% if request.review_dtime %}
            <tr>
                <th>Review Date:</th>
                <td>{{ request.review_dtime.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
            {% endif %}
        </table>
    </div>
</div>
{% endif %}
