You are working in the existing DRIMS PostgreSQL database.
The table reliefrqst already exists and may be referenced by other tables (e.g., reliefrqst_item, workflows, etc.), and it may already contain data.

Your task is to update the existing reliefrqst table so that it matches the target schema below, while:

Preserving the table name: reliefrqst

Preserving or correctly re-creating all constraints, using the names shown

Preserving or correctly re-creating all indexes on reliefrqst

Not breaking any foreign key references from other tables that point to reliefrqst.reliefrqst_id

Preserving existing data wherever it is compatible with the new rules

1️⃣ Target Schema for reliefrqst

Bring the reliefrqst table to exactly this definition:

create table reliefrqst
(
    reliefrqst_id integer not null generated by default as identity
        constraint pk_reliefrqst primary key,

    agency_id integer not null 
        constraint fk_reliefrqst_agency references agency,

    request_date date not null
        constraint c_reliefrqst_1 check (request_date <= CURRENT_DATE),

    -- Randomly generated reference/tracking number for request
    tracking_no varchar(7) not null,
    
    -- Optional event for which the request is being made. Note: If a request is being
    -- made for an event for which the agency is not eligible, the request should be
    -- prevented from being raised.
    eligible_event_id integer
        constraint fk_reliefrqst_event references event,

    urgency_ind char(1) not null
        -- L=Low, M=Medium, H=High, C=Critical
        constraint c_reliefrqst_2 check (urgency_ind in ('L','M','H','C')),

    -- Optional notes related to request and review
    rqst_notes_text text,
    review_notes_text text,

    status_code smallint not null default 0
        constraint fk_reliefrqst_reliefrqst_status references reliefrqst_status,

    -- See relief status table for rules regarding status code and reason.
    -- Reason is optional if the status is not: denied, ineligible nor limited as allowed and closed
    status_reason_desc varchar(255)
        constraint c_reliefrqst_3
        check (
            (status_reason_desc is not null)
            or (status_reason_desc is null and status_code not in (4,6,8))
        ),

    -- Creates/Cancels request
    create_by_id varchar(20) not null,
    create_dtime timestamp(0) without time zone not null,

    -- Submits/Cancels request. Cancellation can be done by creator/reviewer.
    -- Reviewer details must be populated for actions on/after submission. 
    review_by_id varchar(20)
        constraint c_reliefrqst_4a
        check (
            (review_by_id is null and status_code < 2)
            or (review_by_id is not null and status_code >= 2)
        ),
    review_dtime timestamp(0) without time zone
        constraint c_reliefrqst_4b
        check (
            (review_by_id is null and review_dtime is null)
            or (review_by_id is not null and review_dtime is not null)
        ),
    
    -- Actions request: Fill, Part fill, Closes (requested item qty based on allowed limit),
    -- Denies, Designates as Ineligible. Details of "actioner" must be populated for actions
    -- after review.
    action_by_id varchar(20)
        constraint c_reliefrqst_5a
        check (
            (action_by_id is null and status_code < 4)
            or (action_by_id is not null and status_code >= 4)
        ),
    action_dtime timestamp(0) without time zone
        constraint c_reliefrqst_5b
        check (
            (action_by_id is null and action_dtime is null)
            or (action_by_id is not null and action_dtime is not null)
        ),
    
    -- Receives and accepts request
    receive_by_id varchar(20)
        constraint c_reliefrqst_6a
        check (
            (receive_by_id is null and status_code != 9)
            or (receive_by_id is not null and status_code = 9)
        ),
    receive_dtime timestamp(0) without time zone
        constraint c_reliefrqst_6b
        check (
            (receive_by_id is null and receive_dtime is null)
            or (receive_by_id is not null and receive_dtime is not null)
        ),

    version_nbr integer not null
);

create index dk_reliefrqst_1 on reliefrqst(agency_id, request_date);
create index dk_reliefrqst_2 on reliefrqst(request_date, status_code);
create index dk_reliefrqst_3 on reliefrqst(status_code, urgency_ind);


(Note: ensure commas and constraint placement are syntactically correct in the final DDL.)

2️⃣ Requirements & Constraints

When generating the migration:

Do NOT break FKs from other tables

Other tables may reference reliefrqst.reliefrqst_id.

After migration, all such FKs must still exist, with same names and behaviours.

Constraint names must match

Primary key: pk_reliefrqst

Foreign keys:

fk_reliefrqst_agency → agency_id → agency

fk_reliefrqst_event → eligible_event_id → event

fk_reliefrqst_reliefrqst_status → status_code → reliefrqst_status

Check constraints:

c_reliefrqst_1 on request_date

c_reliefrqst_2 on urgency_ind

c_reliefrqst_3 on status_reason_desc vs status_code

c_reliefrqst_4a / c_reliefrqst_4b on review fields

c_reliefrqst_5a / c_reliefrqst_5b on action fields

c_reliefrqst_6a / c_reliefrqst_6b on receive fields

Columns & types must match exactly

Ensure all columns exist with the correct types, nullability, defaults, and constraints.

Indexes must exist with correct names

dk_reliefrqst_1 on (agency_id, request_date)

dk_reliefrqst_2 on (request_date, status_code)

dk_reliefrqst_3 on (status_code, urgency_ind)

Data preservation & cleanup

If the table already contains data:

Before adding tighter CHECK constraints, ensure existing data conforms.

If necessary, generate UPDATE statements to:

Fix invalid request_date (e.g., > CURRENT_DATE) if allowed by business rules.

Ensure urgency_ind, status_code, and various *_by_id / *_dtime combinations satisfy all check constraints.

The migration must not silently lose or corrupt data.

Prefer ALTER TABLE in-place

Use ALTER TABLE reliefrqst ... to:

Add missing columns

Change data types/lengths if compatible

Add or drop constraints to match names and logic

Only consider drop-and-recreate as a last resort, and only if:

All referencing FKs are captured, temporarily dropped, and correctly recreated afterwards.

3️⃣ What to Generate

Produce a single SQL migration script that:

Inspects/assumes current reliefrqst structure and then:

Uses ALTER TABLE commands to:

Add any missing columns

Adjust column types/lengths and defaults where necessary

Add missing constraints with the correct names

Drop and recreate constraints if they exist under different names

Creates or re-creates the three dk_reliefrqst_* indexes.

Optionally includes a data cleanup section at the top to normalize any existing data so that it passes the new CHECK constraints.

Clearly comments logical sections, e.g.:

-- 1. Data cleanup (if needed)
-- 2. Adjust columns
-- 3. Add / replace constraints
-- 4. Add / replace indexes
-- 5. Verify FK integrity


Leaves the database in a state where:

reliefrqst exactly matches the target definition.

All existing references to reliefrqst remain valid.

All required indexes exist and are usable by the query planner.

4️⃣ Scope Limits

Do not modify unrelated tables, except:

Temporarily disabling/re-adding foreign keys referencing reliefrqst, if absolutely necessary.

Do not change application code in this prompt—this is a database migration only.