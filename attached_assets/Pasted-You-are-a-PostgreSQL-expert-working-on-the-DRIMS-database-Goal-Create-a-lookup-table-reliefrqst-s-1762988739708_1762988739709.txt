You are a PostgreSQL expert working on the DRIMS database.

Goal

Create a lookup table reliefrqst_status that holds the valid status_code values and descriptions.

Make sure reliefrqst.status_code is a smallint that references reliefrqst_status.status_code.

Seed reliefrqst_status with the exact codes and descriptions below.

Do not modify any tables other than reliefrqst_status and reliefrqst.

Implement this migration in an idempotent, data-safe way (it can be run multiple times).

Run the following SQL:

BEGIN;

-- 1) Create reliefrqst_status lookup table (if not already present)
CREATE TABLE IF NOT EXISTS reliefrqst_status
(
    status_code     smallint    NOT NULL,
    status_desc     varchar(20) NOT NULL,
    is_active_flag  boolean     NOT NULL DEFAULT TRUE,
    CONSTRAINT pk_reliefrqst_status PRIMARY KEY (status_code)
);

-- 2) Seed / upsert status values
INSERT INTO reliefrqst_status (status_code, status_desc, is_active_flag) VALUES
    (0, 'DRAFT',              TRUE),
    (1, 'Awaiting approval',  TRUE),
    (2, 'CANCELLED',          TRUE),
    (3, 'SUBMITTED',          TRUE),
    (4, 'DENIED',             TRUE),
    (5, 'PART FILLED',        TRUE),
    (6, 'CLOSED',             TRUE),
    (7, 'FILLED',             TRUE)
ON CONFLICT (status_code) DO UPDATE
SET status_desc    = EXCLUDED.status_desc,
    is_active_flag = EXCLUDED.is_active_flag;

-- 3) Ensure reliefrqst table exists and uses the FK to reliefrqst_status
DO $$
BEGIN
  -- If reliefrqst does NOT exist, create it with the desired structure
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_schema = 'public'
      AND table_name   = 'reliefrqst'
  ) THEN

    CREATE TABLE public.reliefrqst
    (
        reliefrqst_id     integer GENERATED BY DEFAULT AS IDENTITY
                          CONSTRAINT pk_reliefrqst PRIMARY KEY,

        agency_id         integer NOT NULL
                          CONSTRAINT fk_reliefrqst_agency
                          REFERENCES agency,

        request_date      date    NOT NULL
                          CONSTRAINT c_reliefrqst_1
                          CHECK (request_date <= CURRENT_DATE),

        -- Optional event for which the request is being made
        eligible_event_id integer
                          CONSTRAINT fk_reliefrqst_event
                          REFERENCES event,

        urgency_ind       char(1) NOT NULL
                          CONSTRAINT c_reliefrqst_2
                          CHECK (urgency_ind IN ('L','M','H','C')),
                          -- L=Low, M=Medium, H=High, C=Critical

        rqst_notes_text   text,
        review_notes_text text,

        status_code       smallint NOT NULL
                          CONSTRAINT fk_reliefrqst_reliefrqst_status
                          REFERENCES reliefrqst_status(status_code),

        -- Creates/Cancels request
        create_by_id      varchar(20) NOT NULL,
        create_dtime      timestamp(0) without time zone NOT NULL,

        -- Submits/Cancels request. Cancellation can be done by creator/reviewer
        review_by_id      varchar(20)
                          CONSTRAINT c_reliefrqst_4a
                          CHECK (
                            (review_by_id IS NULL AND status_code < 2)
                            OR
                            (review_by_id IS NOT NULL AND status_code >= 2)
                          ),
        review_dtime      timestamp(0) without time zone
                          CONSTRAINT c_reliefrqst_4b
                          CHECK (
                            (review_by_id IS NULL AND review_dtime IS NULL)
                            OR
                            (review_by_id IS NOT NULL AND review_dtime IS NOT NULL)
                          ),

        -- Actions request - Fill, Part fill, Closes
        action_by_id      varchar(20)
                          CONSTRAINT c_reliefrqst_5a
                          CHECK (
                            (action_by_id IS NULL AND status_code < 4)
                            OR
                            (action_by_id IS NOT NULL AND status_code >= 4)
                          ),
        action_dtime      timestamp(0) without time zone
                          CONSTRAINT c_reliefrqst_5b
                          CHECK (
                            (action_by_id IS NULL AND action_dtime IS NULL)
                            OR
                            (action_by_id IS NOT NULL AND action_dtime IS NOT NULL)
                          ),

        version_nbr       integer NOT NULL
    );

  ELSE
    -- If reliefrqst already exists, just ensure:
    --  * status_code is smallint
    --  * FK to reliefrqst_status is present

    -- Make sure status_code is smallint (no-op if already smallint)
    ALTER TABLE public.reliefrqst
      ALTER COLUMN status_code TYPE smallint;

    -- Add FK constraint if it doesn't exist
    IF NOT EXISTS (
      SELECT 1 FROM pg_constraint
      WHERE conname = 'fk_reliefrqst_reliefrqst_status'
        AND conrelid = 'public.reliefrqst'::regclass
    ) THEN
      ALTER TABLE public.reliefrqst
        ADD CONSTRAINT fk_reliefrqst_reliefrqst_status
        FOREIGN KEY (status_code)
        REFERENCES public.reliefrqst_status(status_code);
    END IF;

  END IF;
END$$;

-- 4) Ensure indexes on reliefrqst are present
CREATE INDEX IF NOT EXISTS dk_reliefrqst_1
  ON public.reliefrqst (agency_id, request_date);

CREATE INDEX IF NOT EXISTS dk_reliefrqst_2
  ON public.reliefrqst (request_date, status_code);

CREATE INDEX IF NOT EXISTS dk_reliefrqst_3
  ON public.reliefrqst (status_code, urgency_ind);

COMMIT;