create table itembatch
(
	batch_id integer not null generated by default as identity
		constraint pk_itembatch primary key,
	inventory_id integer not null
		constraint fk_itembatch_warehouse references warehouse(warehouse_id),
	item_id integer not null
		constraint fk_itembatch_item references item,

	--Batch number is required where item is defined as received/stored in batches.
	--Where a batch number is optional and none is entered, default to item code.
	batch_no varchar(20) not null
		constraint c_itembatch_1 check(batch_no = upper(batch_no)),

	--Date printed on batch of items or date first received into inventory.
	--Value is determined and entered by custodian.
	batch_date date not null,

	--Batch expiration date. Required if item is defined as subject to expiration.
	--If expiration date is past - should all items be categorized as expired and
	--not usable/reserved/defective.

	expiry_date date,
	
	--Quantity/amount of usable/good item in batch
	usable_qty decimal(12,2) not null
		constraint c_itembatch_2a check (usable_qty >= 0.00),
	
	--Quantity/amount of item reserved/blocked for one/more distributions
	reserved_qty decimal(12,2) not null
		constraint c_itembatch_2b check (reserved_qty <= usable_qty),
	
	--Quantity/amount of defective item in batch
	defective_qty decimal(12,2) not null
		constraint c_itembatch_2c check (defective_qty >= 0.00),
	
	--Quantity/amount of expired item in batch
	expired_qty decimal(12,2) not null
		constraint c_itembatch_2d check (defective_qty >= 0.00),

	--Units in which quantity of item is measured
	uom_code varchar(25) not null
		constraint fk_itembatch_unitofmeasure references unitofmeasure,

	--Item size specification e.g. 10x10 sheets or 10x12 sheets. Size specification
	--is required if item is defined as varying in size of units (units_size_vary_flag).
	size_spec varchar(30),

	--Cost/item or average value computed over items
	avg_unit_value decimal(10,2) not null
		constraint c_itembatch_3 check (avg_unit_value >= 0.00),

	last_verified_by varchar(20),
	Last_verified_date date
		constraint c_itembatch_5
		check ((last_verified_by is null and Last_verified_date is null)
			or (last_verified_by is not null and Last_verified_date is not null)),

	status_code char(1) not null
		--A=Available, U=Unavailable
		constraint c_itembatch_6 check (status_code in ('A','U')),

	--Any comments on item in batch
	comments_text text,
		
	create_by_id varchar(20) not null,
	create_dtime timestamp(0) without time zone not null,
	update_by_id varchar(20) not null,
	update_dtime timestamp(0) without time zone not null,
	version_nbr integer not null
);
--Create unique index on batch in inventory for reference
create unique index uk_itembatch_1 on itembatch(inventory_id,batch_id,item_id);

--Index to ensure one batch number per inventory
create unique index uk_itembatch_2 on itembatch(inventory_id,batch_id);

--Index for retrieving items in inventory
create index dk_itembatch_1 on itembatch(item_id,inventory_id);

--Index to get batch and across inventories
create index dk_itembatch_2 on itembatch(batch_no,inventory_id);